<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Demo</title>
    <style>
        .message-containers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 50%));
            background-color: #7fbe7d; /*TODO, to delete, just helps to work with the element*/
            padding: 10px;
            /*grid-gap: 10px; It makes the percentage weird*/
        }
        .sub-screen {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px;
            max-height: 1000px;
            overflow: auto; /* Add scrollbars if the content overflows */
        }
    </style>
</head>
<body>
<div>
    Enter Port Number: <input type="text" id="port-input">
    <button onclick="connectWebSocket()">Connect</button>
</div>

<div class="message-containers" id="message-containers">
</div>

<script>
    const websocketConnections = {};
    //let currentEvent = null;

    function connectWebSocket() {
        const portInput = document.getElementById('port-input');
        const port = portInput.value;

        if (port) {
            if (websocketConnections[port]) { // TODO, check why this is not working right away when the port does not exists
                alert(`WebSocket connection for Port ${port} already exists.`);
                return;
            }
            // Create the connection
            console.log(websocketConnections)
            const ws = new WebSocket(`ws://localhost:${port}/ws`); // Async connection
            websocketConnections[port] = ws;

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                const currentEventDisplay = document.getElementById(`currEvent-${port}`);
                currentEventDisplay.value = JSON.stringify(message, null, 2);
                //const messageElement = document.createElement('pre');
                //messageElement.textContent = `Received JSON:\n${JSON.stringify(message, null, 2)}`;
                //subScreen.appendChild(messageElement);
            };

            ws.onclose = function() {
                delete websocketConnections[port];
                // subScreen.remove(); // Remove the sub-screen when the WebSocket connection is closed
            };

            createSubScreen(port);

        }
    }

    function createSubScreen(port) {
        const messageContainers = document.getElementById('message-containers');
        const subScreen = document.createElement('div');
        subScreen.className = 'sub-screen';
        subScreen.id = `sub-screen-${port}`;

        const currentEventDisplay = document.createElement('textarea');
        currentEventDisplay.id = `currEvent-${port}`;
        subScreen.appendChild(currentEventDisplay);

        const yesButton = document.createElement('button');
        yesButton.textContent = 'Yes';
        yesButton.onclick = () => makeDecision(port, true);
        subScreen.appendChild(yesButton);

        const noButton = document.createElement('button');
        noButton.textContent = 'No';
        noButton.onclick = () => makeDecision(port, false);
        subScreen.appendChild(noButton);

        // Manage Drag and Drop features
        subScreen.setAttribute('draggable', true);
        subScreen.addEventListener('dragstart', (event) => {
            event.dataTransfer.setData('text/plain', subScreen.id); // Store the sub-screen's ID during drag
        });

        subScreen.addEventListener('dragover', (event) => {
            event.preventDefault(); // Allow the element to be dropped
        });

        subScreen.addEventListener('drop', (event) => {
            event.preventDefault();
            const draggedScreenId = event.dataTransfer.getData('text/plain');
            const draggedScreen = document.getElementById(draggedScreenId);

            // Swap the positions of the dragged element and the drop target
            if (draggedScreen && draggedScreen !== subScreen) {
                const parent = subScreen.parentNode;
                const nextSibling = subScreen.nextElementSibling;
                parent.insertBefore(draggedScreen, subScreen);
                parent.insertBefore(subScreen, nextSibling);
            }
        });

        messageContainers.appendChild(subScreen);

        const messageConsole = document.createElement('div');
        messageConsole.id = `message-console-${port}`;
        messageConsole.className = 'message-console';
        messageConsole.textContent = `WebSocket Console for Port ${port}:`;
        subScreen.appendChild(messageConsole);
    }

    function makeDecision(port, accept) {
        const ws = websocketConnections[port];
        const signal = accept ? "keep" : "drop";
        ws.send(signal);

        if (accept) {
            const currentEventDisplay = document.getElementById(`currEvent-${port}`);
            const eventDisplay = document.getElementById(`message-console-${port}`);
            const eventPara = document.createElement('p');
            eventPara.textContent = currentEventDisplay.value;
            eventDisplay.appendChild(eventPara);
        }

        const currentEventDisplay = document.getElementById(`currEvent-${port}`);
        currentEventDisplay.value = '';
    }
</script>
</body>
</html>
